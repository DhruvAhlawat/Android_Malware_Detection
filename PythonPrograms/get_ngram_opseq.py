#first we gotta reduce the number of instructions actually, to be able to do any n-gram work.
import sys
import os
import shutil
import logging
import pandas as pd
import copy

sys.path.insert(1, os.path.join(sys.path[0], '../..'))
#the first argument should be the directory where we should read the files from.
#the second argument should be the csv file where we should output the result of our analysis.


def generateNgramOpcode(n,s):
    curList = list(s); #split the string into a list of characters
    if(n == 1):
        return curList

    #else what we will do is.
    lowerNgramList = generateNgramOpcode(n-1, s)
    retList = []
    for curChar in curList:
        for curNgram in lowerNgramList:
            retList.append(curNgram+curChar)

    return retList



def main():
    if(len(sys.argv) < 4):
        print( "Usage", sys.argv[0], "<opseq file directory> <output csv file> <n-gram size> <all opcodes file> <Bool : isMalware?>")
        return  
    inputDir = sys.argv[1]
    outputFile = sys.argv[2]
    ngramSize = int(sys.argv[3])
    allOpcodes = open(sys.argv[4]).readline(); allOpcodes = allOpcodes.rstrip('\n');allOpcodes = allOpcodes.rstrip(); #all the opcodes should be in the first line of this file, without spaces.
    isMalware = 1; #by default we assume that the files are malware.
    if(sys.argv[5] == "False"):
        isMalware = 0;
    
    print("reading files from ", inputDir)
    print("outputting to ", outputFile)
    #we need to read all the files in the directory.
    
    opcodeSeqs = []
    for name in os.listdir(inputDir):
        if os.path.isfile(os.path.join(inputDir, name)):
            opcodeSeqs.append(name)
    totalOpSeqsCnt = len(opcodeSeqs)
    print("Total opseqs to be analyzed", totalOpSeqsCnt)
    #now we need to read each file and get the n-grams.
    #first we make a dictionary for the ngrams.
    OriginalNgramDict = {}; #this is the dictionary that we will use to write to the csv file.
    ngramList = generateNgramOpcode(ngramSize, allOpcodes);
    for ngram in ngramList:
        OriginalNgramDict[ngram] = [0]; #adding this as 0 so all files have the same order of ngrams.
    done = 0;
    for opSeq in opcodeSeqs:
        print("Analyzing opseq: ", opSeq, ", remaining: ", totalOpSeqsCnt - done) #such statements let us know how many are analyzed and how many are remaining.
        #read the file
        opSeqFile = open(os.path.join(inputDir, opSeq), "r")
        curNgramDict = copy.deepcopy(OriginalNgramDict)
        
        for line in opSeqFile:
            line = line.rstrip('\n')
            if(line == "" or line == '\n')  : continue
            cur = 0;
            while(cur + ngramSize <= len(line)):
                ngram = line[cur:cur+ngramSize]
                if(ngram in curNgramDict):
                    curNgramDict[ngram][0]+=1
                else:
                    raise Exception("ngram sequence not found in the dictionary")
                    print("ngram seq not fount in dict")
                cur+=1
        #get the n-grams
        frame = pd.DataFrame(curNgramDict); 
        frame.insert(0, "isMalware", [isMalware], True); #insert the isMalware column at the beginning.
        #now that we got the ngrams, we can simply just write their data to the csv file, along with whether they are malicious or not.
        if(done == 0 and isMalware == 0): #if its not malware then we also add the header at the top, hence the benign files should be run first.
            frame.to_csv(outputFile, index = False)
        else:
            frame.to_csv(outputFile, mode='a', header=False, index=False);
        #write the n-grams to the csv file.
        #close the file
        opSeqFile.close()
        done+=1;










if __name__ == '__main__':
    main()






