#!/bin/bash
cd .;
echo -e " Starting Static Analysis ... "

for f in /home/dhruvahlawat/Documents/Android_Malware_Analysis/APKs/$1/*.apk ;
do 
f_Analysed=$(basename $f);
f_Static_Features="$f_Analysed"_Static_Features;
mkdir $2/$f_Analysed/
echo -e "APK: "$f
echo -e " Unpacking using APKTool..."
apktool d $f -o $2/$f_Analysed/ -f 


echo -e " Displaying Package Info in AndroidManifest.xml..."
echo -e " Package : " >> $2/$f_Analysed/$f_Static_Features.txt
grep -oP 'package=.*" ' $2/$f_Analysed/AndroidManifest.xml | sort -u >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying Activities in AndroidManifest.xml..."
echo -e " Activities : " >> $2/$f_Analysed/$f_Static_Features.txt
grep -oP 'activity.*" ' $2/$f_Analysed/AndroidManifest.xml  | cut -f -1  | sort -u >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying Services AndroidManifest.xml..."
echo -e " Services : " >> $2/$f_Analysed/$f_Static_Features.txt
grep -oP 'service .*"' $2/$f_Analysed/AndroidManifest.xml | sort -u >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying Content Providers in AndroidManifest.xml..."
echo -e " Providers : " >> $2/$f_Analysed/$f_Static_Features.txt
grep -oP 'provider .*"' $2/$f_Analysed/AndroidManifest.xml | sort -u >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying Broadcast Receivers in AndroidManifest.xml..."
echo -e " Receivers : " >> $2/$f_Analysed/$f_Static_Features.txt
grep -oP 'receiver .*"' $2/$f_Analysed/AndroidManifest.xml | sort -u >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying Intent Filter Actions in AndroidManifest.xml..."
echo -e " Intents Action : " >> $2/$f_Analysed/$f_Static_Features.txt
grep -oP 'action.*".*"' $2/$f_Analysed/AndroidManifest.xml | sort -u >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying Intent Filter Categories in AndroidManifest.xml..."
echo -e " Intents Category : " >> $2/$f_Analysed/$f_Static_Features.txt
grep -oP 'category.*"' $2/$f_Analysed/AndroidManifest.xml | sort -u >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying Permissions in AndroidManifest.xml..."
echo -e " Permissions : " >> $2/$f_Analysed/$f_Static_Features.txt
grep -oP 'permission.*"' $2/$f_Analysed/AndroidManifest.xml  | sort -u >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying Exports in AndroidManifest.xml..."
echo -e " Exported : " >> $2/$f_Analysed/$f_Static_Features.txt
grep -oP 'exported="true".*"' $2/$f_Analysed/AndroidManifest.xml | sort -u >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying Backups in AndroidManifest.xml..."
echo -e " Backup : " >> $2/$f_Analysed/$f_Static_Features.txt
egrep -o 'allowBackup.*" ' $2/$f_Analysed/AndroidManifest.xml | sort -u >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying meta-data in AndroidManifest.xml..."
echo -e " Meta-Data : " >> $2/$f_Analysed/$f_Static_Features.txt
grep -oP 'meta-data.*"' $2/$f_Analysed/AndroidManifest.xml | sort -u >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying uses-features in AndroidManifest.xml..."
echo -e " Uses-Features : " >> $2/$f_Analysed/$f_Static_Features.txt
egrep -i 'uses-features.*"' $2/$f_Analysed/AndroidManifest.xml | sort -u >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying Number of icons..."
echo -e " Number of Icons : " >> $2/$f_Analysed/$f_Static_Features.txt
find $2/$f_Analysed/ -iname "*.png" -type f -printf '.' | wc -c  >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying Number of Pictures..."
echo -e " Number of Pictures : " >> $2/$f_Analysed/$f_Static_Features.txt
find $2/$f_Analysed/* -iname "*.jpg" -type f -printf '.' | wc -c  >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying Number of Audio..."
echo -e " Number of Audio : " >> $2/$f_Analysed/$f_Static_Features.txt
find $2/$f_Analysed/* -iname "*.mp3" -type f -printf '.' | wc -c  >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying Number of Videos..."
echo -e " Number of Videos : " >> $2/$f_Analysed/$f_Static_Features.txt
find $2/$f_Analysed/* -iname "*.mp4" -type f -printf '.' | wc -c  >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " Displaying Size of the App..."
echo -e " Size of the App : " >> $2/$f_Analysed/$f_Static_Features.txt
du -sh $2/$f_Analysed/ | cut -f -1 >> $2/$f_Analysed/$f_Static_Features.txt
echo -e "  " >> $2/$f_Analysed/$f_Static_Features.txt

echo -e " DONE!"
echo -e "Removing everything apart from the generated text file"
#find ./$2/$f_Analysed/ -type f -not -name '*.txt' -delete
#find ./$2/$f_Analysed/* -type d -not -name '*.txt' -delete
#find ./DecodedFiles/$f_Analysed/* -type d -not \(-name "*.txt" -or -name "*.xml" \)  -delete

cd ./$2/$f_Analysed
ls . | grep -v -e "$f_Static_Features".txt -e 'AndroidManifest.xml' | xargs rm -rf
cd ../..

echo -e " Finally DONE!" ;

done
