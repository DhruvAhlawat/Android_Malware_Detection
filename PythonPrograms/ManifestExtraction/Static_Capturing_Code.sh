#!/bin/bash
cd .;
echo -e " Starting Static Analysis ... "

for f in $1/*.apk* ;
do 
f_Analysed=$(basename $f);
f_Static_Features="$f_Analysed"_Static_Features;
#mkdir $f/
echo -e "APK: "$f

#no unpacking files incase the file has already been unpacked before using APKTool while working on 

#echo -e " Unpacking using APKTool..."
#apktool d $f -o $f/ -f 


echo -e " Displaying Package Info in AndroidManifest.xml..."
echo -e " Package : " >> $f/$f_Static_Features.txt
grep -oP 'package=.*" ' $f/AndroidManifest.xml | sort -u >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying Activities in AndroidManifest.xml..."
echo -e " Activities : " >> $f/$f_Static_Features.txt
grep -oP 'activity.*" ' $f/AndroidManifest.xml  | cut -f -1  | sort -u >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying Services AndroidManifest.xml..."
echo -e " Services : " >> $f/$f_Static_Features.txt
grep -oP 'service .*"' $f/AndroidManifest.xml | sort -u >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying Content Providers in AndroidManifest.xml..."
echo -e " Providers : " >> $f/$f_Static_Features.txt
grep -oP 'provider .*"' $f/AndroidManifest.xml | sort -u >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying Broadcast Receivers in AndroidManifest.xml..."
echo -e " Receivers : " >> $f/$f_Static_Features.txt
grep -oP 'receiver .*"' $f/AndroidManifest.xml | sort -u >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying Intent Filter Actions in AndroidManifest.xml..."
echo -e " Intents Action : " >> $f/$f_Static_Features.txt
grep -oP 'action.*".*"' $f/AndroidManifest.xml | sort -u >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying Intent Filter Categories in AndroidManifest.xml..."
echo -e " Intents Category : " >> $f/$f_Static_Features.txt
grep -oP 'category.*"' $f/AndroidManifest.xml | sort -u >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying Permissions in AndroidManifest.xml..."
echo -e " Permissions : " >> $f/$f_Static_Features.txt
grep -oP 'permission.*"' $f/AndroidManifest.xml  | sort -u >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying Exports in AndroidManifest.xml..."
echo -e " Exported : " >> $f/$f_Static_Features.txt
grep -oP 'exported="true".*"' $f/AndroidManifest.xml | sort -u >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying Backups in AndroidManifest.xml..."
echo -e " Backup : " >> $f/$f_Static_Features.txt
egrep -o 'allowBackup.*" ' $f/AndroidManifest.xml | sort -u >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying meta-data in AndroidManifest.xml..."
echo -e " Meta-Data : " >> $f/$f_Static_Features.txt
grep -oP 'meta-data.*"' $f/AndroidManifest.xml | sort -u >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying uses-features in AndroidManifest.xml..."
echo -e " Uses-Features : " >> $f/$f_Static_Features.txt
egrep -i 'uses-features.*"' $f/AndroidManifest.xml | sort -u >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying Number of icons..."
echo -e " Number of Icons : " >> $f/$f_Static_Features.txt
find $f/ -iname "*.png" -type f -printf '.' | wc -c  >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying Number of Pictures..."
echo -e " Number of Pictures : " >> $f/$f_Static_Features.txt
find $f/* -iname "*.jpg" -type f -printf '.' | wc -c  >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying Number of Audio..."
echo -e " Number of Audio : " >> $f/$f_Static_Features.txt
find $f/* -iname "*.mp3" -type f -printf '.' | wc -c  >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying Number of Videos..."
echo -e " Number of Videos : " >> $f/$f_Static_Features.txt
find $f/* -iname "*.mp4" -type f -printf '.' | wc -c  >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " Displaying Size of the App..."
echo -e " Size of the App : " >> $f/$f_Static_Features.txt
du -sh $f/ | cut -f -1 >> $f/$f_Static_Features.txt
echo -e "  " >> $f/$f_Static_Features.txt

echo -e " DONE!"

#Uncomment the below code to remove all the unnecessary generated files and keep only the generated text file, along with the Manifest.xml file.

#echo -e "Removing everything apart from the generated text file"
# cd ./$f
# ls . | grep -v -e "$f_Static_Features".txt -e 'AndroidManifest.xml' | xargs rm -rf
# cd ../..

echo -e " Finally DONE!" ;

done
