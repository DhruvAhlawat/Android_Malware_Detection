# %%
import pandas as pd
import sys
import numpy as np
#import matplotlib.pyplot as plt
import os
import time
import sklearn as sk
from sklearn.model_selection import train_test_split
from sklearn.metrics import confusion_matrix, accuracy_score 
from sklearn import svm
from sklearn.ensemble import RandomForestClassifier
import matplotlib.pyplot as plt
import multiprocessing as mp

# the first argument, if provided, corresponds to the number of estimators to use in the random forest

estimators = 50;
if(len(sys.argv) >= 2):
   estimators = int(sys.argv[1]);  




# %% [markdown]
# ## Loading the datasets
ScriptStartTime = time.time();
# %%
DataDict = {}
dir1 = '/home/akadir.iitr/Dhruv/largeDatasetRun/Data/Experimentation/CorrelationSupport'
#for file in os.listdir(dir1):
#    DataDict[file] = pd.read_csv(os.path.join(dir1, file))
dir2 = '/home/akadir.iitr/Dhruv/largeDatasetRun/Data/Experimentation/SupportCorrelationScore'
#for file in os.listdir(dir2):
#    DataDict[file] = pd.read_csv(os.path.join(dir2,file)); 
dir3 = '/home/akadir.iitr/Dhruv/largeDatasetRun/Data/Experimentation/Support'
#for file in os.listdir(dir3):
#    DataDict[file] = pd.read_csv(os.path.join(dir3,file)); 
#DataDict['main'] = pd.read_csv('/home/akadir.iitr/Dhruv/largeDatasetRun/Data/largeDataset.csv')
label = 'Labels'

# %% [markdown]
# 

# %%
df_train = {}; df_test = {}; timeTaken = {}
#for data in DataDict:
#    df_train[data], df_test[data] = train_test_split(DataDict[data], test_size=0.2, random_state=40, stratify=DataDict[data][label]) #, random_state=5)
    

# %%
RF = {}
maxAcc = 0; maxAccName = ""; 
AccList = {dir1:[], dir2:[], dir3:[]};

def processFile(dir, file, lock):
    i = file; 
    DataDict[file] = pd.read_csv(os.path.join(dir,file));     
    df_train[file], df_test[file] = train_test_split(DataDict[file], test_size=0.2, random_state=40, stratify=DataDict[file][label]) #, random_state=5)
    RF[i] = RandomForestClassifier(n_estimators=estimators, random_state=0); timeTaken[i] = [time.time(),0];
    RF[i].fit(df_train[i].drop([label], axis=1), df_train[i][label]); timeTaken[i] = [time.time() - timeTaken[i][0], time.time()];
    Acc = RF[i].score(df_test[i].drop([label], axis=1), df_test[i][label]); timeTaken[i][1] = time.time() - timeTaken[i][1];
    retVal = [df_train[i].shape[1], Acc*100, i, timeTaken[i][0], timeTaken[i][1]]; 
    return retVal;
def processDirs(dir, lock, acclist):
    args = []
    retVal = [];
    for i in os.listdir(dir):
        args.append((dir, i, lock));
    with mp.Pool(mp.cpu_count()) as p:
      #acclist[dir] =        retVal = p.starmap(processFile, args);
        retVal = p.starmap(processFile, args);
    retVal = sorted(retVal, key=lambda x: float(x[1]), reverse=True);
#    lock.acquire();
#    try:
#        for i in retVal:
#            print(i);
#    finally:
#            lock.release();
#    print(); print();
    acclist.put((dir, retVal));

if( __name__ == '__main__'):
    with mp.Manager() as manager:
        Q = mp.Queue(); 
        lock = manager.Lock();
        P1 = mp.Process(target=processDirs, args = (dir1,lock, Q))
        P2 = mp.Process(target=processDirs, args = (dir2,lock, Q))
        P3 = mp.Process(target=processDirs, args = (dir3,lock, Q))
        P1.start()
        P2.start()
        P3.start()
        P1.join()
        P2.join()
        P3.join()
        D1 = Q.get();
        D2 = Q.get();
        D3 = Q.get();
        AccList[D1[0]] = D1[1];
        AccList[D2[0]] = D2[1];
        AccList[D3[0]] = D3[1];


fig, ax = plt.subplots(figsize=(12,12));

colors = {dir1:'crimson', dir2:'blue', dir3:'green'};

for name in AccList:

    AccList[name] = sorted(AccList[name], key = lambda x: float(x[1]), reverse=True); 
    if(AccList[name][0][1] > maxAcc):
            maxAccName = AccList[name][0][2]; 
            maxAcc = AccList[name][0][1]; 
    for i in range(len(AccList[name])-1,-1,-1):
        if(AccList[name][i][1] < AccList[name][0][1] - 1.4):
            AccList[name].pop(); #we remove all those values which generate an accuracy that is severely lesser than the topmost accuracy that we achieved.
   
    print(name, " -> "); 
    for x in AccList[name]:
        print(x[1],' numFeatures = ', x[0], x[2],' Time: train= ', x[3],' test= ',  x[4]); 


    x = [x[0] for x in AccList[name]]
    y = [x[1] for x in AccList[name]]

    ax.scatter(x,y, alpha=0.7,color=colors[name], label= os.path.basename(name)); 

ax.set_xlabel('Number of Features')
ax.set_ylabel('Accuracy')
ax.legend()
plt.title("Random Forest Model ~ {}  estimators".format(estimators))

fig.savefig('AccuracyDataRF{}'.format(estimators), dpi=200.0);




print();

print("Max Accuracy: ", maxAcc, " for ", maxAccName)    
print("Total time taken: ", time.time() - ScriptStartTime); 
# %%



