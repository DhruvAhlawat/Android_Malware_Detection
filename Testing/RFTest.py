# %%
import pandas as pd
import sys
import numpy as np
#import matplotlib.pyplot as plt
import os
import time
import sklearn as sk
from sklearn.model_selection import train_test_split
from sklearn.metrics import confusion_matrix, accuracy_score 
from sklearn import svm
from sklearn.ensemble import RandomForestClassifier
import matplotlib.pyplot as plt

# the first argument, if provided, corresponds to the number of estimators to use in the random forest

estimators = 600;
if(len(sys.argv) >= 2):
   estimators = int(sys.argv[1]);  




# %% [markdown]
# ## Loading the datasets
ScriptStartTime = time.time();
# %%
DataDict = {}
dir1 = '/home/akadir.iitr/Dhruv/largeDatasetRun/Data/Experimentation/CorrelationSupport'
for file in os.listdir(dir1):
    DataDict[file] = pd.read_csv(os.path.join(dir1, file))
dir2 = '/home/akadir.iitr/Dhruv/largeDatasetRun/Data/Experimentation/SupportCorrelationScore'
for file in os.listdir(dir2):
    DataDict[file] = pd.read_csv(os.path.join(dir2,file)); 
dir3 = '/home/akadir.iitr/Dhruv/largeDatasetRun/Data/Experimentation/Support'
for file in os.listdir(dir3):
    DataDict[file] = pd.read_csv(os.path.join(dir3,file)); 
#DataDict['main'] = pd.read_csv('/home/akadir.iitr/Dhruv/largeDatasetRun/Data/largeDataset.csv')
label = 'Labels'

# %% [markdown]
# 

# %%
df_train = {}; df_test = {}; timeTaken = {}
for data in DataDict:
    df_train[data], df_test[data] = train_test_split(DataDict[data], test_size=0.2, random_state=40, stratify=DataDict[data][label]) #, random_state=5)
    

# %%
RF = {}
maxAcc = 0; maxAccName = ""; 

AccList = {}; AccList[dir1] = []; AccList[dir2] = []; AccList[dir3] = []


for i in df_train:  
    RF[i] = RandomForestClassifier(n_estimators=estimators, random_state=0); timeTaken[i] = [time.time(),0];
    RF[i].fit(df_train[i].drop([label], axis=1), df_train[i][label]); timeTaken[i] = [time.time() - timeTaken[i][0], time.time()];
    Acc = RF[i].score(df_test[i].drop([label], axis=1), df_test[i][label]); timeTaken[i][1] = time.time() - timeTaken[i][1];
    
    if(Acc > maxAcc):
        maxAcc = Acc
        maxAccName = i
    
    #Then we need to check where does this file belong to, in which folder that is.
    if(os.path.exists(os.path.join(dir1, i))):
        AccList[dir1].append([df_train[i].shape[1],Acc, i, timeTaken[i][0], timeTaken[i][1]]);
    elif(os.path.exists(os.path.join(dir2,i))):
        AccList[dir2].append([df_train[i].shape[1],Acc, i, timeTaken[i][0], timeTaken[i][1]]);
    else:
        AccList[dir3].append([df_train[i].shape[1],Acc, i, timeTaken[i][0], timeTaken[i][1]]);

#    AccList.append([df_train[i].shape[1],Acc, i, timeTaken[i][0], timeTaken[i][1]]);  

fig, ax = plt.subplots(figsize=(12,12));

colors = {dir1:'crimson', dir2:'blue', dir3:'green'};

for name in AccList:

    AccList[name] = sorted(AccList[name], key = lambda x: float(x[1]), reverse=True); 
    
    for i in range(len(AccList[name])-1,-1,-1):
        if(AccList[name][i][1] < AccList[name][0][1] - 0.014):
            AccList[name].pop(); #we remove all those values which generate an accuracy that is severely lesser than the topmost accuracy that we achieved.
    
    print(name, " -> "); 
    for x in AccList[name]:
        print(x[1],' numFeatures = ', x[0], x[2],' Time: train= ', x[3],' test= ',  x[4]); 


    x = [x[0] for x in AccList[name]]
    y = [x[1] for x in AccList[name]]

    ax.scatter(x,y, alpha=0.7,color=colors[name], label= os.path.basename(name)); 

ax.set_xlabel('Number of Features')
ax.set_ylabel('Accuracy')
ax.legend()
plt.title("Random Forest Model ~ {}  estimators".format(estimators))

fig.savefig('AccuracyDataRF{}'.format(estimators));




print();

print("Max Accuracy: ", maxAcc, " for ", maxAccName)    
print("Total time taken: ", time.time() - ScriptStartTime); 
# %%



